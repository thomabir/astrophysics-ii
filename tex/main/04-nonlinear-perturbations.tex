\chapter{Nonlinear Perturbations}

\section{Approaches for non-linear structure formation}

Remember that at late times, perturbations become non-linear, and that small-scale perturbations become non-linear first.
Perturbations collapse to form dark halos, filaments, and pancakes.
This structure is called the cosmic web, which is a signature of non-linear gravitational instability in an expanding universe.
% movie (illustris collaboration)

Studying the evolution of non-linear perturbations is very difficult, and no exact analytic solutions have yet been found in the fully non-linear regime.
There are different approaches to tackle the problem:
\begin{itemize}
	\item Numerical simulations
	\item Higher order perturbation theory is only a valid approach for mildly non-linear perturbations and scales.
	On small scales, this does not work.
	\item The Halo model, which is a simplified model, is very successful in describing the formation, evolution, and statistics of collapsed structures.
\end{itemize}

We will study mainly the Halo model. We start with a model that only contains dark matter, and later introduce baryons.

\section{Spherical Collapse}

We consider a spherical overdensity with in an otherwise homogeneous expanding universe. Outside the sphere, the density is $\bar{\rho}$, while inside it is $\rho = \bar{\rho}(1+\delta)$.

We make a few simplifying assumptions:
\begin{itemize}
	\item The universe is flat and matter-dominated, such that $\Omega_0 = \Omega_{\text{m}, 0} = 1$.
	\item There is only collisionless dark matter.
\end{itemize}
We now look at a thin shell with radius $r$ inside the top-hat sphere, and write down its equation of motion. Newton's second law states
\begin{align*}
	\dv[2]{r}{t}
	&= - \frac{G M}{r^2},
\end{align*}
where $M$ is the mass inside the radius $r$,
\begin{align*}
	M = M(r) = \frac{4\pi r^3}{3} \bar{\rho}(1+\delta).
\end{align*}
Note that $M(r)$ is constant as long as the different shells don't cross each other, which we assume for now.
The energy per unit mass of the shell, also called its specific energy $\epsilon$, is the sum of a kinetic and a potential term:
\begin{align*}
	\epsilon = \frac{1}{2} \left( \dv{r}{t} \right)^2
	- \frac{G M}{r},
\end{align*}
which is constant because of conservation of energy.
If $\epsilon \geq 0$, the shell expands forever, and if $\epsilon < 0$, the shell might expand for a while, but will eventually contract and collapse. We will focus on the latter case.

The solution of the equation of motion for $\epsilon < 0$ is
\begin{align*}
	r &= A(1- \cos \theta) &
	t &= B(\theta - \sin\theta) &
	A &= \frac{GM}{2 \abs{\epsilon}} &
	B &= \frac{GM}{(2 \abs{\epsilon})^{2/3}}
\end{align*}
The solution $r(t)$ is plotted in \cref{fig:shell-collapse-r}.
The shell expands, reaches a maximum radius $r_\text{ta} = 2 A$ at $t_\text{ta} = \pi B$, and collapses at $t_\text{coll} = 2 t_\text{ta}$.
However, the model will be invalid shortly before $t_\text{coll}$, since shells start crossing and virialize, which will be discussed later.
\begin{figure}
	\centering
	\import{img/ch-04/}{shell-evolution-r.pdf_tex}
	\caption{The evolution of the shell radius of a spherical overdensity, with negative total energy. The shell expands, reaches a maxium radius, and collapses, which is described by the analytical solution derived in the text. Shortly before collapse, the solution becomes invalid as shells start crossing.}
	\label{fig:shell-collapse-r}
\end{figure}



We would also like to derive an expression for $\rho(t)$ inside the sphere, and find the critical density which is required for collapse. To do this, we use a few more of our assumptions and perform some approximations.

At an early time $t_i$, we define $r=r_i$ and $v = v_i$. We assume that at $t_i$, the shell follows the Hubble flow:
\begin{align*}
	v_i
	&= \dv{(a x_i)}{t} 
	= \dot{a} x_i &&\text{no peculiar velocity, and } r = a x\\
	&= H r_i.
	&& H = \dot{a}/a 
\end{align*}
Plugging in at $t=t_i$, we find
\begin{align*}
	M
	= \frac{4\pi r_i^3}{3}  \bar{\rho}(t_i)(1+\delta_i),
	\qquad
	\epsilon
	= \frac{v_i^2}{2}  - \frac{GM}{r_i}.
\end{align*}
Since we assumed a matter-dominated universe, $a \propto t^{2/3}$, and $H = 2/(3t)$. We also assumed a flat universe, so
\begin{align*}
	\bar{\rho}
	= \rho_\text{crit}
	= \frac{1}{6\pi G t^2}.
\end{align*}
We can plug these expressions into the definitions of $A$ and $B$ to get
\begin{align*}
	A = \frac{3}{10} \frac{r_i}{\delta_i},
	\qquad
	B = \frac{9}{20} \frac{t_i}{\delta_i}.
\end{align*}

The density inside the top hat sphere is then
\begin{align*}
	\rho
	&= \frac{M}{\frac{4\pi}{3}r^3}
	= \frac{3M}{4\pi A^3} (1-\cos\theta)^{-3}
	&&\text{because } r = A(1-\cos\theta),
\end{align*}
while outside it is
\begin{align*}
	\bar{\rho}
	&= \frac{1}{6\pi G t^2}
	= \frac{1}{6 \pi G B^2} (\theta-\sin\theta)^{-2}
	&& \text{because } t = B(\theta - \sin\theta).
\end{align*}
It follows that
\begin{align*}
	1 + \delta
	= \frac{\rho}{\bar{\rho}}
	= \frac{9}{2} \frac{(\theta-\sin\theta)^{2}}{(1-\cos\theta)^3}.
\end{align*}
Since we want to find $\rho(t)$ instead of $\rho(\theta)$, we have a little more work to do.
An analytical solution is nowhere to be seen, so we try to find at least an approximation.
At early times, $t << t_\text{ta}$, we perform a Taylor expansion in $t$ and $\theta$ to get
\begin{align*}
	\delta \approx \frac{3}{20} \theta^2
	\qquad
	t \approx \frac{B}{6} \theta^3.
\end{align*}
These two expressions can be combined to find
\begin{align*}
	\delta
	= \frac{3}{20} \left( \frac{6 t}{B} \right)^{2/3}
	= \frac{3}{20} (6\pi)^{2/3} \left( \frac{t}{t_\text{ta}} \right)^{2/3},
\end{align*}
which is fortunately\sidenote{Since we assumed early times, linear perturbation theory should still be valid, so comparing our new result to what we found in the previous chapter gives us some reassurance that everything still works correctly.} in agreement with what we found in linear perturbation theory for a matter-dominated universe, where we derived $D(z) \propto a \propto t^{2/3}$.
Note that this result is only valid at early times, and the actual value of $\delta$ might be quite different at later times. To make things clearer, we define
\begin{align*}
	\delta_\text{lin} = \frac{3}{20} (6\pi)^{2/3} \left( \frac{t}{t_\text{ta}} \right)^{2/3},
\end{align*}
and expect $\delta = \delta_\text{lin}$ at early times, but not at late times. We can find $\rho$ from $\delta$, and $\rho_\text{lin}$ from $\delta_\text{lin}$, which is a more intuitive value. The relationship between $\rho$, $\rho_\text{lin}$, and the density outside the sphere, $\bar{\rho}$, is shown in \cref{fig:shell-collapse-rho}.

\begin{figure}
	\centering
	\import{img/ch-04/}{shell-evolution-rho.pdf_tex}
	\caption{The evolution of the density of a spherical overdensity with negative total energy. The exact model is $\rho$, which agrees well with the linearised approximation $\rho_\text{lin}$ at early times, but only until the turn-around time. For reference, the average density $\bar{\rho}$ of the universe outside the sphere is also shown.}
	\label{fig:shell-collapse-rho}
\end{figure}

The overdensity from the linearized model and the exact model at different times are compared in \cref{tab:exact-vs-lin}.
We notice that the overdensities are larger than one, which in hindsight clarifies why we require non-linear perturbation theory. In the previous chapter, we always assumed $\delta \ll 1$, which is obviously not valid any more.
\begin{margintable}
	\begin{tabular}{lll}
		\toprule
		model & $t_\text{ta}$ & $t_\text{coll}$\\
		\midrule
		$\delta$ & 4.55 & $\infty$\\
		$\delta_\text{lin}$ & 1.062 & 1.686\\
		\bottomrule
	\end{tabular}
	\caption{Overdensities in the linearized and the exact model at different times.}
	\label{tab:exact-vs-lin}
\end{margintable}

Depending on the cosmological models, the overdensity $\delta_c$ required for collapse is different. We have so far worked with a simplified CDM model (sCDM), where we assumed that the universe is flat and dominated by collisionless dark matter. For other cosmologies, such as OCDM and ΛCDM, it turns out that multiplying the sCDM result with an additional factor yields a good approximation:
\begin{align*}
	\delta_c \approx
	\begin{cases}
	1.686 & \text{for sCDM}\\
	1.686 [\Omega_m(t_\text{coll})]^{0.0185} & \text{for OCDM}\\
	1.686 [\Omega_m(t_\text{coll})]^{0.0055} & \text{for ΛCDM}
	\end{cases}
\end{align*}




\section{Collisionless dynamics}

% aka stellar dynamics

In the previous chapter, we assumed a collisionless medium. To find out when this approximation is valid, we look at the collision time-scales in thermodynamic equilibrium.

We consider a system with $N$ self-gravitating particles and diameter $r$.
Each particle $i$ has a velocity $\vec{v}_i$ and a mass $m$. The average velocity is $v = \avg{v_i}$.
There are several relevant time scales.
\begin{itemize}
	\item The \emph{crossing time scale} $t_\text{cross}$ is the time required for a typical particle to cross the system:
	\begin{align*}
		t_\text{cross} = \frac{r}{v}
	\end{align*}

	\item The \emph{time scale for close encounters} $t_\text{close}$ is the average time between close encounters.
	To calculate it, we look at a gravitational two-body interaction of two close particles.
	We define an encounter as a close encounter if the change of the speed of the particle due to the interaction is similar to the initial speed,
	\begin{align*}
		\delta_v
		\defeq \abs*{\vec{v}_\text{before} - \vec{v}_\text{after}}
		\approx \vec{v}_\text{before}.
	\end{align*}
	Then we define $t_\text{close}$ as the average time between close encounters,\sidenote{It seems counter-intuitive that the time between encounters increases with particle size. This has to do with our assumption that the system is in thermodynamic equilibrium, where the velocity goes down for constant $m$ and $r$.}
	\begin{align*}
		t_\text{close}
		= N t_\text{cross}.
	\end{align*}

	\item The \emph{relaxation time scale} $t_\text{relax}$ is the time required for the particle velocity distribution to relax to a new distribution.
	Consider a cumulative change in velocity $\Delta v^2$ over the motion of a particle.
	We define $t_\text{relax}$ as the time scale for which $\Delta v^2$ is comparable to $v^2$. One can show that
	\begin{align*}
		t_\text{relax}
		\defeq \frac{N}{10 \ln N} t_\text{cross}.
	\end{align*}
\end{itemize}

In typical astrophysical systems with $N \gg 100$, such as galaxies and galaxy clusters, we usually find
\begin{align*}
	t_\text{close} \gg t_\text{relax} \gg t_H \gg t_\text{cross},
\end{align*}
where $t_H = H^{-1} \approx \SI{e10}{\year}$ is the Hubble time.
Collisions are thus so rare that we can treat many systems as effectively collisionless.

For example, in a galaxy we have $r \approx \SI{10}{\kilo\parsec}$, $v \approx \SI{200}{\kilo\meter\per\second}$, and $N \approx 10^{10}$, which yields
\begin{align*}
	t_\text{close} &= \SI{5e17}{\year},\\
	t_\text{relax} &= \SI{2e15}{\year},\\
	t_H &= \SI{e10}{\year},\\
	t_\text{cross} &= \SI{5e7}{\year}.
\end{align*}
Gravitational collisions are apparently very inefficient and can be neglected for these systems, so we can use the collisionless Boltzmann equation. Instead of analysing two-body forces, we can use a smooth mean gravitational potential.

We now look at the collisionless Boltzmann equation (CBE), with a phase-space distribution function $f(\vec{x}, \vec{v}, t)$.
As we've seen before, the moments of $f$ are
\begin{itemize}
	\item $n(\vec{x}, t) = \int f(\vec{x}, \vec{v}, t) \dd{^3v} = p(\vec{x}, t)/m$
	\item $\avg{Q}(\vec{x}, t) = \frac{1}{n} \int \dd{^3v} Q f(\vec{x}, \vec{v}, t)$
\end{itemize}
The evolution of the distribution function is given by the CBE,
\begin{align*}
	\dv{f}{t}
	= \pdv{f}{t} + \sum_i \pdv{f}{x_i} \dv{x_i}{t} + \sum_i \pdv{f}{v_i} \dv{v_i}{t}
	= 0,
\end{align*}
which can be rewritten with $v_i = \dv*{x_i}{t}$ and $\dv*{v_i}{t} = - \pdv*{\Phi}{x_i}$ as
\begin{align*}
	\pdv{f}{t} + \sum_i v_i \pdv{f}{x_i} - \sum_i \pdv{\Phi}{x_i} \pdv{f}{v_i} = 0,
\end{align*}
where the gravitational potential can be calculated from the Poisson equation, $\Lap \Phi = 4 \pi G \rho$.

We can take moments of the CBE to get
\begin{align*}
	\pdv{}{t} [n \avg{Q}]
	+ \sum_{i} \pdv{}{x_i}[n \avg{Q v_i}]
	+ n \sum_{i} \pdv{\Phi}{x_i} \avg{ \pdv{Q}{v_i} }
	= 0,
\end{align*}
where we used partial integration to obtain the last term. If we take $Q = 1$, we get
\begin{align*}
	\pdv{n}{t} + \sum_{i} \pdv{}{x_i} [n \avg{v_i}]
	= 0,
\end{align*}
which we recognize as the continuity equation of an ideal fluid, with $n$ instead of $\rho$.

For $Q = v_j$, we obtain
\begin{align*}
	\pdv{}{t}[n \avg{v_j}]
	+ \sum_{i} \pdv{}{x_i} [n \avg{v_i v_j}]
	+ n \pdv{\Phi}{x_j}
	= 0.
\end{align*}
Again, we define
\begin{align*}
	\sigma_{ij}^2 = \avg{v_i v_j} - \avg{v_i} \avg{v_j}
\end{align*}
to get
\begin{align*}
	0
	&= \pdv{n}{t} \avg{v_j}
	+ n \pdv{\avg{v_j}}{t}
	+ \sum_{i} \pdv{}{x_i} [n \sigma_{ij}^2]
	+ \sum_{i} \pdv{}{x_i} [n \avg{v_i}\avg{v_j}]
	+ n \pdv{\Phi}{x_j}\\
	&= \pdv{n}{t} \avg{v_j}
	+ n \pdv{\avg{v_j}}{t}
	+ n \sum_{i} \pdv{}{x_i} [n \sigma_{ij}^2]
	+ \sum_{i} \pdv{}{x_i}[n \avg{v_i}] \avg{v_j}
	+ \sum_{i} n \avg{v_i} \pdv{}{x_i} \avg{v_j}
	+ n \pdv{\Phi}{x_j}\\
	&= n \pdv{\avg{v_j}}{t}
	+ n \sum_{i} \pdv{}{x_i} [n \sigma_{ij}^2]
	+ \sum_{i} n \avg{v_i} \pdv{}{x_i} \avg{v_j}
	+ n \pdv{\Phi}{x_j}
	&& \text{continuity equation}
	\\
	&= \pdv{\avg{v_j}}{t}
	+ \sum_{i} \avg{v_i} \pdv{\avg{v_j}}{x_i}
	+ \frac{1}{n} \sum_{i} \pdv{(n \sigma_{ij}^2)}{x_i}
	+ \pdv{\Phi}{x_i}
\end{align*}
which is the Euler equation, but with $n \sigma_{ij}^2$ instead of $p$ and $n$ instead of $\rho$. We already stated this result in the previous chapter, and now we have proven it. The equation in this form is called the \emph{Jeans equation}.

If we take the Jeans equation, the continuity equation, and the Poisson equation, we have a total of five equations in the 11 unknowns $\rho$, $v_i$, $\sigma_{ij}$ (6, because it is symmetric) and $\rho$. Evidently, we have too many unknowns. We could try to take higher moments of the CBE, but this only adds more unknowns in the end. In order to close the system, we need more assumptions.\sidenote{We didn't have this problem for an ideal fluid, because the equation of state was used.}




\section{Virial theorem}
Consider a localized self-gravitating collisionless system in a steady state, such as an isolated galaxy. A steady state means that the distribution function does not depend on time, but only on $\vec{x}$ and $\vec{v}$.

The Euler equation for such a system is
\begin{align*}
	0
	&= \pdv{}{t} [n \avg{v_j}]
	+ \sum_{i} \pdv{}{x_i} [n \avg{v_i v_j}]
	+ n \pdv{\Phi}{x_j}\\
	&= \sum_{i} \pdv{}{x_i} [n \avg{v_i v_j}]
	+ n \pdv{\Phi}{x_j}
	&&\text{steady state:} \pdv*{f}{t} = 0
\end{align*}
We multiply the equation by $- \int \dd{^3x} m x_k$ and recall $\rho = n m$ to get
\begin{align*}
	0
	&= - \sum_{i} \int x_k \pdv{[\rho \avg{v_i v_j}]}{x_i} \dd{^3 x}
	   - \int \rho x_k \pdv{\Phi}{x_j} \dd{^3 x}
\end{align*}
We define $2 K_{jk}$ as the first term, and $W_{jk}$ as the second term, so $2 K_{jk} + W_{jk} = 0$.
The first term can be written using the product rule as
\begin{align*}
	&- \sum_{i} \int \dd{^3 x} \left[
		\pdv{}{x_i} \left( x_k \rho \avg{v_i v_j} \right) 
		- \pdv{x_k}{x_i} \rho \avg{v_i v_j}
	\right]\\
	&= \sum_{i} \left[
       \oint \dd{S_i} x_k \rho \avg{v_i v_j}
	   - \int \dd{^3 x} \delta_{ik} \rho \avg{v_i v_j}
	   \right]
	&&\text{divergence theorem}\\
	&= - \sum_{i} \int \dd{^3 x} \delta_{ik} \rho \avg{v_i v_j}
	&&\rho = 0 \text{ at border}
\end{align*}
By taking the trace of $2 K_{jk} + W_{jk} = 0$, we get
\begin{align*}
	2 K + W = 0,
\end{align*}
where
\begin{align*}
	K
	&= \tr(K_{ij})
	= \frac{1}{2} \int \dd{^3x} \rho \avg{v^2},\\
	W &= \tr(W_{ij})
	= - \int \dd{^3 x} \rho \vec{x} \cdot \Grad \Phi
	= \frac{1}{2} \int \dd{^3 x} \rho \Phi,
\end{align*}
which can be shown to be the kinetic and the potential energy of the system, respectively.
Since the total energy of the system is $E = K + W$, we finally obtain
\begin{align*}
	2 K + W = 0,
\end{align*}
which is Virial theorem. It is also commonly written as $E = - K = W/2$. We call a system virialized if the Virial theorem is valid.

The Virial theorem can be used to estimate the total mass of a system. Note that $K \approx M \bar{v}^2/2$, where $M$ is the total mass of the system, and $\bar{v}$ is the average velocity of the particles. Also, $W \approx -GM^2/R$, where $R$ is the diameter of the system. The Virial theorem yields
\begin{align*}
	\bar{v}^2 \approx \frac{GM}{R}.
\end{align*}
This can be used to estimate the mass of a system from measurements of $\bar{v}$ and $R$.




This can be applied to the spherical collapse model.
% TODO figure again
Let $E = K + W$ be the conserved total energy of the sphere.

At $t_\text{ta}$, the kinetic energy is zero, so $E = W_\text{ta}$, which is the gravitational potential energy of a solid sphere with radius $r_\text{ta}$:
\begin{align*}
	E = - \frac{3}{5} \frac{G M^2}{r_\text{ta}}.
\end{align*}

At $t = t_\text{coll}$, which is also called $t_\text{vir}$, the energy is
\begin{align*}
	E
	&= \frac{W_\text{vir}}{2}
	&&\text{Virial theorem}\\
	&\approx \frac{1}{2}\left( - \frac{3}{5} \frac{GM^2}{r_\text{vir}} \right).
\end{align*}
Because the energy is conserved, the two results can be combined to yield
\begin{align*}
	r_\text{vir} = \frac{r_\text{ta}}{2}.
\end{align*}
The mean overdensity within $r_\text{vir}$ at $t_\text{vir}$ is
\begin{align*}
	1 + \Delta
	&= \frac{\rho(t_\text{vir})}{\bar{\rho}}\\
	&= \frac{ \rho(t_\text{ta}) \left(\frac{r_\text{ta}}{r_\text{vir}}\right)^3  }{\bar{\rho}(t_\text{vir})}\\
	&= \frac{\rho(t_\text{ta})}{\bar{\rho}(t_\text{ta})}
	\frac{\bar{\rho}(t_\text{ta})}{\bar{\rho}(t_\text{vir})}
	\left( \frac{r_\text{ta}}{r_\text{vir}} \right)^3\\
	&= \frac{9\pi^2}{16}   2^2 2^3
	&&\text{see section 4.2, } a \propto t^{2/3}, \text{ } \bar{\rho} \propto a^{-3}\\
	&\approx 178
\end{align*}

% TODO diagram again

\section{Steady state solutions}

We want to find solutions of the CBE which are steady states, meaning we want $f$ to be time-independent. The CBE for a steady state is
\begin{align*}
	0
	&= \sum_{i} \pdv{f}{x_i} \dv{x_i}{t}
	+ \sum_{i} \pdv{f}{v_i} \dv{v_i}{t}.
\end{align*}
We consider integrals of motion, which are functions $I(\vec{x}, \vec{v})$ that are constant along particle trajectories.
Examples of such functions are energy and angular momentum.
For integrals of motion,
\begin{align*}
	0 &= \dv{I}{t}\\
	&= \sum_{i} \pdv{I}{x_i} \dv{x_i}{t}
	+ \sum_{i} \pdv{I}{v_i} \dv{v_i}{t}.
\end{align*}
Thus, integrals of motion are solutions of the CBE.
Conversely, a distribution function $f$ which is a function of integrals of motion, written as
\begin{align*}
	f(\vec{x}, \vec{v}) = f(I_1(\vec{x}, \vec{v}), \dots, I_N(\vec{x}, \vec{v})),
\end{align*}
is necessarily a steady-state solution of the CBE.

Thus, all solutions of the steady state CBE depend on $\vec{x}$ and $\vec{v}$ through integrals of motion. This result is called \emph{Jean's theorem}.

There are some special cases.

One is a spherical solution where $f$ only depends on the specific energy of a particle,
\begin{align*}
	E = \frac{1}{2} v^2 + \Phi(\vec{x}).
\end{align*}
We can relate $f(E)$ to the density profile $\rho(r)$ of the system.











